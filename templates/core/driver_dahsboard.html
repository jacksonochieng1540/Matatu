{% extends 'base.html' %}
{% load humanize %}

{% block title %}Driver Dashboard - MatatuBook{% endblock %}

{% block extra_css %}
<style>
    .trip-timeline {
        position: relative;
        padding-left: 40px;
    }
    
    .trip-timeline-item {
        position: relative;
        padding-bottom: 30px;
    }
    
    .trip-timeline-item::before {
        content: '';
        position: absolute;
        left: -28px;
        top: 5px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primary-color);
        border: 3px solid white;
        box-shadow: 0 0 0 2px var(--primary-color);
    }
    
    .trip-timeline-item::after {
        content: '';
        position: absolute;
        left: -21px;
        top: 21px;
        width: 2px;
        height: 100%;
        background: #e9ecef;
    }
    
    .trip-timeline-item:last-child::after {
        display: none;
    }
    
    .trip-timeline-item.completed::before {
        background: var(--success-color);
        box-shadow: 0 0 0 2px var(--success-color);
    }
    
    .trip-card-action {
        border-left: 5px solid;
    }
    
    .trip-card-action.scheduled {
        border-left-color: #3b82f6;
    }
    
    .trip-card-action.in-progress {
        border-left-color: #f59e0b;
    }
    
    .trip-card-action.completed {
        border-left-color: #10b981;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Driver Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-1">Welcome, Driver {{ user.get_full_name }}! ðŸš—</h2>
            <p class="text-muted">License: {{ driver.license_number }} | PSVB: {{ driver.psvb_badge }}</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <button class="btn btn-outline-primary" onclick="toggleAvailability()">
                    {% if driver.is_available %}
                    <i class="bi bi-pause-circle"></i> Go Offline
                    {% else %}
                    <i class="bi bi-play-circle"></i> Go Online
                    {% endif %}
                </button>
            </div>
        </div>
    </div>
    
    <!-- Stats Row -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm" style="border-left: 4px solid #3b82f6;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Today's Trips</h6>
                            <h3 class="mb-0">{{ today_trips.count }}</h3>
                        </div>
                        <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                            <i class="bi bi-calendar-check text-primary fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card shadow-sm" style="border-left: 4px solid #10b981;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total Trips</h6>
                            <h3 class="mb-0">{{ driver.total_trips }}</h3>
                        </div>
                        <div class="rounded-circle bg-success bg-opacity-10 p-3">
                            <i class="bi bi-check-circle text-success fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card shadow-sm" style="border-left: 4px solid #f59e0b;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Rating</h6>
                            <h3 class="mb-0">{{ driver.rating }}<small class="text-muted">/5.0</small></h3>
                        </div>
                        <div class="rounded-circle bg-warning bg-opacity-10 p-3">
                            <i class="bi bi-star-fill text-warning fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card shadow-sm" style="border-left: 4px solid #8b5cf6;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Status</h6>
                            <h3 class="mb-0">
                                {% if driver.is_available %}
                                <span class="badge bg-success">Online</span>
                                {% else %}
                                <span class="badge bg-secondary">Offline</span>
                                {% endif %}
                            </h3>
                        </div>
                        <div class="rounded-circle bg-purple bg-opacity-10 p-3">
                            <i class="bi bi-person-check text-purple fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Today's Schedule -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-calendar-day"></i> Today's Schedule</h5>
                    <span class="badge bg-white text-primary">{{ today_trips.count }} Trip{{ today_trips.count|pluralize }}</span>
                </div>
                <div class="card-body">
                    {% if today_trips %}
                    <div class="trip-timeline">
                        {% for trip in today_trips %}
                        <div class="trip-timeline-item {% if trip.status == 'completed' %}completed{% endif %}">
                            <div class="card trip-card-action {{ trip.status }} mb-0">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <div class="d-flex justify-content-between mb-2">
                                                <h6 class="mb-0">{{ trip.route.name }}</h6>
                                                {% if trip.status == 'scheduled' %}
                                                <span class="badge bg-primary">Scheduled</span>
                                                {% elif trip.status == 'boarding' %}
                                                <span class="badge bg-info">Boarding</span>
                                                {% elif trip.status == 'in_transit' %}
                                                <span class="badge bg-warning">In Transit</span>
                                                {% elif trip.status == 'completed' %}
                                                <span class="badge bg-success">Completed</span>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="row g-2 small text-muted mb-3">
                                                <div class="col-auto">
                                                    <i class="bi bi-clock"></i> {{ trip.departure_time|time:"g:i A" }}
                                                </div>
                                                <div class="col-auto">
                                                    <i class="bi bi-bus-front"></i> {{ trip.vehicle.registration_number }}
                                                </div>
                                                <div class="col-auto">
                                                    <i class="bi bi-people"></i> {{ trip.bookings.count }} bookings
                                                </div>
                                                <div class="col-auto">
                                                    <i class="bi bi-chair"></i> {{ trip.available_seats }}/{{ trip.total_seats }} seats
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewBookings({{ trip.id }})">
                                                    <i class="bi bi-list"></i> View Bookings
                                                </button>
                                                <button class="btn btn-sm btn-outline-info" onclick="viewRoute({{ trip.id }})">
                                                    <i class="bi bi-map"></i> Route Details
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4 text-end">
                                            {% if trip.status == 'scheduled' %}
                                            <button class="btn btn-primary w-100 mb-2" onclick="startBoarding({{ trip.id }})">
                                                <i class="bi bi-door-open"></i> Start Boarding
                                            </button>
                                            {% elif trip.status == 'boarding' %}
                                            <button class="btn btn-success w-100 mb-2" onclick="startTrip({{ trip.id }})">
                                                <i class="bi bi-play-circle"></i> Start Trip
                                            </button>
                                            {% elif trip.status == 'in_transit' %}
                                            <button class="btn btn-warning w-100 mb-2" onclick="completeTrip({{ trip.id }})">
                                                <i class="bi bi-check-circle"></i> Complete Trip
                                            </button>
                                            {% elif trip.status == 'completed' %}
                                            <button class="btn btn-outline-secondary w-100 mb-2" disabled>
                                                <i class="bi bi-check-all"></i> Completed
                                            </button>
                                            {% endif %}
                                            
                                            {% if trip.conductor %}
                                            <small class="text-muted">
                                                <i class="bi bi-person"></i> {{ trip.conductor.user.get_full_name }}
                                            </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-calendar-x display-1 text-muted"></i>
                        <h5 class="mt-3">No Trips Today</h5>
                        <p class="text-muted">You don't have any trips scheduled for today</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="mb-1">Nairobi to Mombasa completed</h6>
                                    <small class="text-muted">Yesterday at 5:30 PM</small>
                                </div>
                                <span class="badge bg-success">Completed</span>
                            </div>
                        </div>
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="mb-1">License renewal reminder</h6>
                                    <small class="text-muted">2 days ago</small>
                                </div>
                                <span class="badge bg-warning">Reminder</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Driver Info -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-person-badge"></i> Driver Information</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" alt="{{ user.get_full_name }}" 
                             class="rounded-circle" style="width: 80px; height: 80px; object-fit: cover;">
                        {% else %}
                        <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center"
                             style="width: 80px; height: 80px; font-size: 30px;">
                            {{ user.first_name.0 }}{{ user.last_name.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">License Number</small>
                        <div>{{ driver.license_number }}</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">License Expiry</small>
                        <div>{{ driver.license_expiry|date:"M d, Y" }}</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">PSVB Badge</small>
                        <div>{{ driver.psvb_badge }}</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">PSVB Expiry</small>
                        <div>{{ driver.psvb_expiry|date:"M d, Y" }}</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">SACCO</small>
                        <div>{{ driver.sacco.name }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Performance -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-graph-up"></i> Performance This Month</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small">Trips Completed</span>
                            <strong>0</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small">Average Rating</span>
                            <strong>{{ driver.rating }}/5.0</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: {{ driver.rating|floatformat:0|add:'0' }}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small">On-Time Arrivals</span>
                            <strong>0%</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Links -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-link-45deg"></i> Quick Links</h6>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action">
                        <i class="bi bi-file-earmark-text"></i> View Reports
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <i class="bi bi-calendar-range"></i> View Schedule
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <i class="bi bi-star"></i> View Reviews
                    </a>
                    <a href="{% url 'profile' %}" class="list-group-item list-group-item-action">
                        <i class="bi bi-person"></i> Edit Profile
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleAvailability() {
    if (confirm('Are you sure you want to change your availability status?')) {
        // AJAX call to toggle availability
        fetch('/api/driver/toggle-availability/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

function startBoarding(tripId) {
    if (confirm('Start boarding for this trip?')) {
        updateTripStatus(tripId, 'boarding');
    }
}

function startTrip(tripId) {
    if (confirm('Start the trip? Make sure all passengers are on board.')) {
        updateTripStatus(tripId, 'in_transit');
    }
}

function completeTrip(tripId) {
    if (confirm('Mark this trip as completed?')) {
        updateTripStatus(tripId, 'completed');
    }
}

function updateTripStatus(tripId, status) {
    // AJAX call to update trip status
    fetch(`/api/trips/${tripId}/status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to update trip status');
        }
    });
}

function viewBookings(tripId) {
    window.location.href = `/trips/${tripId}/bookings/`;
}

function viewRoute(tripId) {
    window.location.href = `/trips/${tripId}/route/`;
}
</script>
{% endblock %}